---
title: "Shiny App Template"
author: "Taylor Kirk"
format: pdf
editor: visual
---

## Env Set Up

```{r echo=FALSE, warning=FALSE}

library(fpp3)
library(tidyverse)
library(gt)

```

## Data Import

```{r data-import}
#| echo: false

# loads the raw dataset, a Monthly time series of 6 wine varietals extending from Jan 1980 to Dec 1994

aus_wine <- read_csv(here::here("data/AustralianWines.csv"), na = "*",
                     col_types = cols(Rose = col_number()),
                     show_col_types = FALSE) |> 
    fill(Rose, .direction = "down") |> 
    mutate(Month = mdy(str_replace(Month, '-', '-01-')) |> yearmonth()) |> 
    rename(Sparkling = sparkling)

# Original data has 7 columns, first column is a Month column and the next 6 are the different varietals.  The values of the varietals are the sales numbers.  the below code block narrows the dataframe down to 3 columns; Month, Varietals and Sales, then converts it into a tsibble

wine_ts <- aus_wine |> 
    pivot_longer(
        cols = c(Fortified:`Dry white`), 
        names_to = "Varietal", 
        values_to = "Sales"
        ) |> 
    as_tsibble(
        index = Month,
        key = Varietal
    )
```

# Tab 1: Explore

- Purpose of this tab is to allow the user to explore the data

UI components
- Multi-select checkbox for wine varietal options to view time series plots
- Date range selection to allow the user to select a custom date range of when to view the time series

Outputs
- Allow the user to toggle between viewing the time series of 1 or multiple wine varietals or the STL decomposition components

Constraints
- for STL decomposition, only allow the user to view one varietal at a time

## Visuals

```{r visuals}

# Add titles
# Extra: Include feature components as annotations or some UI output

# time series, allow user to select multiple varietals and data ranges
wine_ts |> 
    # filter('date range') |> 
    autoplot() +
    facet_wrap(. ~ Varietal, ncol = 1, scales = "free_y") +
    theme_minimal()

# STL decomp, only select one varietal at a time

wine_ts |> 
    filter(Varietal == "Sweet white") |> # filter option here
    model(STL()) |> 
    components() |> 
    autoplot() +
    theme_minimal()
```

# Tab2: Modeling

- Purpose of this tab is to allow the user to build and compare models 

UI components
- Allow the user to choose the forecast_horizon.  Let the options be between 1 and 5 years
    - Forecast_horizon the user chooses will be used to create the training data
    
- Allow user to choose the wine varietal they'd like to model.  This will be a single select dropdown, and the choices will be the unique values found in the varietal column

- User can then choose which model they'd like to use.  The choices will be ETS, TSLM and ARIMA.  the format for the code to build the models will be ETS: ETS(Sales), TSLM: TSLM(Sales ~ trend() + season()), ARIMA: ARIMA(Sales)

Outputs
- Once the model is built, use report() to output the report of the model and have that output as code.  Can only utilize this for one model at a time, allow user to choose the model for report() if they have built multiple
- Output training metric table, allow the user to output and compare multiple models if they've built more than one
- Some sort of tracker so the user knows which models they've built, the model specs and wine varietal that was modeled

Constraints
- Forecast_horizon, wine_varietal and model must all be chosen first before model can be built
- Saved each model built to it's own variable so the user can build multiple models and compare their metrics in the training table and validation table (that's on the 3rd tab)

## Data Split

```{r split data}

forecast_horizon <- 2 # Variable user chooses
trn_cutoff <- max(year(wine_ts$Month)) - forecast_horizon 

# training data
trn_data <- wine_ts |> 
    filter(year(Month) <= trn_cutoff)

```

## Model Build

```{r Model building}

# Build and save multiple models to be able to use for comparison
# Extra: Choose specific components of the model

varietal_choice <- "Red" # this is a user choice

varietal_model <- trn_data |> 
    filter(Varietal == varietal_choice) |> 
    model(
        ETS(Sales) # user choice for model.  Other choices are ARIMA(Sales) and TSLM(Sales ~ trend() + season())
    )

varietal_model |> 
    report() # full report, maybe output this as code

# Add title so we know these are training metrics
varietal_model |> # training metrics, should update column names to be suitable for presentation
    accuracy() |> 
    select(Varietal:MAPE) |> 
    gt() |> 
    fmt_number(decimal = 2)

```

# Tab 3: Forecasting and validation metrics

- Purpose of this tab is to allow the user to make forecasts with their model (or models), and compare validation metrics and forecasts

UI Components
- Multi-select checkbox that allows the user to select the models they want to compare.  The options will be however many models they built in the previous tab.  The choices should output as the model and wine varietal that was modeled
- Optional year filter for the user to cutoff the time series added to the forecast plot through the autolayer() method to get a clearer look at the forecast.  If no option is selected, then the entire time series is plotted with the forecast

Constraints
- In the year filter, don't include the years in the forecast period (if forecast period is 1 year, then the max year the user can cutoff the time series plot at is 1993)
- The validation metric table output can include up to 10 models
- The forecasting plot can include up to 4 models at a time

## Forecasting

```{r forecasting}

# Forecast_horizon the user chose in the previous tab was in years, so we multiple by 12 here (months in a year) so they forecast is for the proper number of periods

varietal_fc <- varietal_model |> 
    forecast(h = forecast_horizon * 12)

# Add title to this so we know these are validation metrics for the forecast period
varietal_fc |> 
    accuracy(data = wine_ts) |> 
    select(.model:MAPE) |> 
    gt() |> 
    fmt_number(decimal = 2)
```

## Visualize Forecasting

```{r visual forecasting}

year_list <- wine_ts |> distinct(year(Month)) |> head(n = -forecast_horizon) # choices for the user to choose between except if they encroach on forecasted years

# clarity_cutoff <- Optional filter for user to trim down the data in the forecast to get a clearer view of the forecast period.  Options come from year_list

varietal_fc |> 
    autoplot() +
    autolayer(
        wine_ts |> 
            filter(Varietal == varietal_choice# , 
                          # year(Month) >= clarity_cutoff
                          )
    )
```
